<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Record Audio</title>
  </head>
  <body>
    <button id="recordButton" onmousedown="startRecording()" onmouseup="stopRecording()">Record</button>
    <script>
      const startRecording = async () => {
        chunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'audio/mp3' });
          const url = URL.createObjectURL(blob);
          console.log(url);

          const formData = new FormData()
          formData.append("audio_file", blob)

          fetch("http://127.0.0.1:8000/upload_audio/", {
            method: 'POST',
            body: formData
          })
          .then(response => {
            console.log("Response from the server:", response);

            var binaryData = []
            binaryData.push(response.blob)
            var src = window.URL.createObjectURL(new Blob(binaryData, {type: "audio/mp3"}))

            const audioElement = new Audio(src);
            audioElement.play();
          })
          .catch(error => {
            console.error("Error from the server:", error);
          })
        };
        mediaRecorder.start();
      };

      const stopRecording = () => {
        console.log("stopping recording")
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      };

      navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        console.log('You let me use your mic!')
      })
      .catch(function(err) {
        console.log('No mic for you!')
      });
    </script>
  </body>
</html>