<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Record Audio</title>
  </head>
  <body>
    <audio id="audio-thinking-0">
      <source src="/static/hmm,_let_me_think.mp3" type="audio/mp3">
    </audio>
    <audio id="audio-thinking-1">
      <source src="/static/Good_question,_let_me_think_about_it....mp3" type="audio/mp3">
    </audio>
    <button id="recordButton" onmousedown="startRecording()" onmouseup="stopRecording()">Record</button>
    <script>
      function sleep(ms) {
       return new Promise(resolve => setTimeout(resolve, ms));
      }
      function getRandomInt(max) {
        return Math.floor(Math.random() * max);
      }

      var isResponding = false

      const startRecording = async () => {
        if (isResponding) {
          return;
        }
        isResponding = true;
        chunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/mp3' });
          const url = URL.createObjectURL(blob);
          console.log(url);

          const formData = new FormData()
          formData.append("audio_file", blob)

          fetch("http://localhost:8004/upload_audio/", {
            method: 'POST',
            body: formData
          })
          .then(response => response.blob())
          .then((blob) => {
            const objectURL = URL.createObjectURL(blob);
            const audioElement = new Audio();
            audioElement.src = objectURL;
            audioElement.play();
            isResponding = false;
          })
          .catch(error => {
            console.error("Error from the server:", error);
            isResponding = false;
          })

          await sleep(1500);

          var idx = getRandomInt(2)

          var audio_elem_id = "audio-thinking-"+idx
          console.log(audio_elem_id)
          console.log(idx)

          var thinkingAudio = document.getElementById(audio_elem_id);
          thinkingAudio.play()
        };
        mediaRecorder.start();
      };

      const stopRecording = () => {
        console.log("stopping recording")
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      };

      navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        console.log('You let me use your mic!')
      })
      .catch(function(err) {
        console.log('No mic for you!')
      });
    </script>
  </body>
</html>