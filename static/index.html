<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Record Audio</title>
  </head>
  <body>
    <audio id="audio-thinking">
      <source src="/static/hmm,_let_me_think.mp3" type="audio/mp3">
    </audio>
    <button id="recordButton" onmousedown="startRecording()" onmouseup="stopRecording()">Record</button>
    <script>
      function sleep(ms) {
       return new Promise(resolve => setTimeout(resolve, ms));
      }

      const startRecording = async () => {
        chunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/mp3' });
          const url = URL.createObjectURL(blob);
          console.log(url);

          const formData = new FormData()
          formData.append("audio_file", blob)

          fetch("http://localhost:8004/upload_audio/", {
            method: 'POST',
            body: formData
          })
          .then(response => response.blob())
          .then((blob) => {
            const objectURL = URL.createObjectURL(blob);
            const audioElement = new Audio();
            audioElement.src = objectURL;
            audioElement.play();
          })
          .catch(error => {
            console.error("Error from the server:", error);
          })

          await sleep(1500);

          var thinkingAudio = document.getElementById("audio-thinking");
          thinkingAudio.play()
        };
        mediaRecorder.start();
      };

      const stopRecording = () => {
        console.log("stopping recording")
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      };

      navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        console.log('You let me use your mic!')
      })
      .catch(function(err) {
        console.log('No mic for you!')
      });
    </script>
  </body>
</html>